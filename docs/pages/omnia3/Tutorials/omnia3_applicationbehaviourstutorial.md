---
title: Application Behaviours Tutorial
keywords: omnia3
summary: "Develop an application behaviour for external API call"
sidebar: omnia3_sidebar
permalink: omnia3_applicationbehaviourstutorial.html
folder: omnia3
---

## 1. Introduction

After you have completed the [Advanced Tutorial](omnia3_advancedtutorial.html), whose result is a functional order management application, this tutorial focus on the usage of application behaviours on the existing Purchase Order Document.

In this example, we'll be adding an external API that will fetch the current currency values and exchange rates, and we'll add that valuable decision making information directly into the purchase order process.

As our external API, to get exchange rate and currency values, we are going to use the [Exchange Rate API](https://exchangeratesapi.io/).

## 2. Prerequisites

This tutorial assumes that you have created a OMNIA tenant, and are logged in as a user with modeling privileges to this tenant.

It is necessary to have completed the steps in the [Advanced Tutorial](omnia3_advancedtutorial.html), as this tutorial builds upon it.

## 3. Application Behaviours

1. Access your modeling area and create a new _Generic Entity_, by accessing the **_Business / Generic Entities_** menu option, and clicking "**_Add New_**". Set its name as "**_Currency_**", and define it as a **_root entity_**

   ![Create_New_GenEntity_Currency](/images/tutorials/applicationbehaviours/create-generic-currency.jpg)

2. Now let's create references to your newly created _Generic Entity_. Go to **_Business / Agents_** and select "**Company**", and add a new **reference attribute**:

   - Name: "**CompanyCurrency**"
   - Type: "**Generic Entity**" > "**Currency**"

     2.1 Repeat the process for the agent "**Supplier**":

     - Name: "**SupplierCurrency**"
     - Type: "**Generic Entity**" > "**Currency**"

3. Now go to your **Purchase Order Document**, and add three new attributes:

   - **CompanyCurrency**:
     - _Type_: _Reference_
     - Attribute Type: _Generic Entity_ > "**Currency**"
     - _Is read only?_: Yes
   - **SupplierCurrency**
     - _Type_: _Reference_
     - Attribute type: _Generic Entity_ > "**Currency**"
     - _Is read only?_: Yes
   - **ExchangeRate** - _Type_: **Primitive** - Attribute Type: _Decimal_ - _Is read only?_: Yes
     3.1. Edit the Purchase Order form by going to **_User Interface / Forms_** and selecting the **PurchaseOrderForm**. Change the layout of your newly created elements:
   - _SupplierName_:
     - **Row**: 2;
     - **Column**: 9;
     - **Size**: 4;
   - _CompanyCurrency_:

     - **Row**: 4;
     - **Column**: 1;
     - **Size**: 2;

   - _SupplierCurrency_:

     - **Row**: 4;
     - **Column**: 2;
     - **Size**: 2;

   - _ExchangeRate_:
     - **Row**: 4;
     - **Column**: 3;
     - **Size**: 2;

   ![PurchaseOrderDocumentLayout](/images/tutorials/applicationbehaviours/purchase-order-layout.jpg)

4. Now that we have all the elements created, let's review our **Entity Behaviours** to fetch the **_Company_** and **_Supplier_** currencies and retrieve the rate between them.

   4.1. Add a new **Action/Change** Entity Behaviour:

   - **Name**: _OnChange_Company_
   - **Action to attribute**: _Company_
   - **Code**:

   ```C#
   // Code generated by an accelerator (you can change it if you need)
   // The following code invokes the API to retrieve the data of an entity and set the values in the current entity
   if(string.IsNullOrEmpty(this.Company?.ToString()))
       return;

   // In order to prevent to invoke the API if the values were sent by the user
   if(
       this._Dto.HasPropertyChanged(nameof(this.CompanyCurrency))
   )
       return;

   var httpClient = this._Context.CreateApplicationHttpClient();
   var dataSource = "Default";

   var requestResult = httpClient.GetAsync($"Company/{dataSource}/{this.Company}").GetAwaiter().GetResult();

   if (!requestResult.IsSuccessStatusCode)
       throw new Exception($"Can't retrieve the entity '{this.Company}'");


   var entity = requestResult.Content.ReadAsAsync<CompanyDto>().GetAwaiter().GetResult();

   this.CompanyCurrency = entity.CompanyCurrency;
   ```

   4.2. Edit existing **GetSupplierName** Behaviour (replace existing code with the following):

   ```C#

   // Code generated by an accelerator (you can change it if you need)
   // The following code invokes the API to retrieve the data of an entity and set the values in the current entity
   if(string.IsNullOrEmpty(this.Supplier?.ToString()))
       return;

   // In order to prevent to invoke the API if the values were sent by the user
   if(
       this._Dto.HasPropertyChanged(nameof(this.SupplierName)) &&
       this._Dto.HasPropertyChanged(nameof(this.SupplierCurrency))
   )
       return;

   var httpClient = this._Context.CreateApplicationHttpClient();
   var requestResult = httpClient.GetAsync($"Supplier/Default/{this.Supplier}").GetAwaiter().GetResult();

   if (!requestResult.IsSuccessStatusCode)
       throw new Exception($"Can't retrieve the entity '{this.Supplier}'");

   var entity = requestResult.Content.ReadAsAsync<SupplierDto>().GetAwaiter().GetResult();

   this.SupplierName = entity._name;
   this.SupplierCurrency = entity.SupplierCurrency;

   ```

   4.3. Edit the existing **After Change** Behaviour and **add** the following code:

   ```C#
   if(!string.IsNullOrEmpty(this.Company) && !string.IsNullOrEmpty(this.Supplier))
   {
   var rateArgs = new Dictionary<string, object>() {

     { "from", this.CompanyCurrency }, { "to", this.SupplierCurrency }

   };

   var result = SystemApplicationBehaviours.GetExchangeRate(rateArgs);

   this.ExchangeRate = (decimal)result["Rate"];

   } else {
       this.ExchangeRate = 0;
   }
   ```

5. Let's add our _Application Behaviour_ that will fetch our currency rates from an external API. Go to **_Business / Application Behaviours_** and click on "**Add new**" button. name it "GetExchangeRate", select **System** as _Data Source_ and then add the following code:

   ```C#
   var fromCurrency = (args.ContainsKey("from") ? args["from"].ToString() : "").ToUpperInvariant();
   var toCurrency = (args.ContainsKey("to") ? args["to"].ToString() : "").ToUpperInvariant();

   if(string.IsNullOrEmpty(fromCurrency) || string.IsNullOrEmpty(toCurrency))
   throw new Exception($"Both currencies must be sended to calculate the rate.");

   if(string.Equals(fromCurrency, toCurrency))

   return new Dictionary<string, object>() { { "Rate", 1m } };

   HttpClient httpClient = new HttpClient();

   var response = httpClient.GetAsync($"http://api.exchangeratesapi.io/v1/latest?base={fromCurrency}&symbols={toCurrency}&access_key=b5d9b28bbd5df2380b1944ad3be46b3d")
       .GetAwaiter()
       .GetResult();

   if (!response.IsSuccessStatusCode)
   throw new Exception($"Can't retrieve the rate between {fromCurrency} and {toCurrency}");

   var responseData = response.Content.ReadAsAsync<Dictionary<string, object>>().GetAwaiter().GetResult();
   if(!responseData.ContainsKey("rates"))
        throw new Exception($"Can't retrieve the rate between {fromCurrency} and {toCurrency}");

   var rate = (responseData["rates"] as JObject)[toCurrency].ToObject<decimal>();

   return new Dictionary<string, object>() { { "Rate", rate } };
   ```

6. Now open your Application Behaviour, go to "Edit Namespaces" (bottom-left corner), and add two new Namespaces, as follows:

   Namespace 1:

   - **Name**: NetHttp;
   - **Fully Qualified Name**: System.Net.Http;

   Namespace 2:

   - **Name**: NewtonsoftLinq;
   - **Fully Qualified Name**: Newtonsoft.Json.Linq

   ![App_Behaviour_Namespaces](/images/tutorials/applicationbehaviours/application-behaviour-namespaces.jpg)

7. Build & Deploy model

8. Before we check our results, we just need to create two currency instances, that will fetch it's value automatically. On your application area, access "Currency" (Configurations > Currency) and add two new instances:

   - _Code_: **EUR**; _Name_: **Euro**;
   - _Code_: **USD**; _Name_: **US Dollar**;

9. Now access the "**AnalogSound**" _Company_ (Configurations > Company), and select one "**_Company Currency_**" from the list. Now repeat the process for your _Supplier_ (Configurations > Supplier) and add the other currency so you can see the functionality in action.

10. Create a new Purchase Order and select a "_Company_" and a "_Supplier_" to verify that the "_Rate_" is automatically calculated when you **change the "Supplier"**, and that's it, your first Application Behaviour is complete!

![AppBehaviourFinalResult](/images/tutorials/applicationbehaviours/tutorial-result.jpg)

Our next tutorial is about Data Sources, [click here](omnia3_datasourcetutorial.md) to get started right away.
